#!/usr/bin/env php
<?php

if (strpos(__DIR__, 'vendor') === false) {
    require __DIR__ . '/../vendor/autoload.php';
} else {
    // assume vendor to be on include_path if installed
    require 'vendor/autoload.php';
}

use Graviton\ImportExport\Command\ImportCommand;
use Graviton\ImportExport\Command\CoreExportCommand;
use Graviton\ImportExport\Command\CoreImportCommand;
use Graviton\ImportExport\Command\CorePurgeCommand;
use Graviton\ImportExport\Service\FileSender;
use Symfony\Component\Console\Application;
use Symfony\Component\Finder\Finder;
use Symfony\Component\Yaml\Parser;
use Symfony\Component\VarDumper\Cloner\VarCloner;
use Symfony\Component\VarDumper\Dumper\CliDumper as Dumper;
use GuzzleHttp\Client;
use Webuni\FrontMatter\FrontMatter;
use Symfony\Component\Filesystem\Filesystem;
use Graviton\ImportExport\Util\JsonSerializer;

$client = new Client();

$application = new Application();
$application->add(
    new ImportCommand(
        $client,
        new Finder(),
        new FrontMatter(),
        new Parser(),
        new VarCloner(),
        new Dumper(),
        new FileSender($client)
    )
);

if (class_exists('\MongoClient')) {
    // do we have special mongo credentials?
    $mongoCredentials = \Graviton\ImportExport\Util\MongoCredentialsProvider::getConnection();

    $application->add(
        new CoreImportCommand(
            $mongoCredentials['db'],
            new FrontMatter(),
            new JsonSerializer(),
            new Finder()
        )
    );
    $application->add(
        new CoreExportCommand(
            $mongoCredentials['db'],
            new Filesystem(),
            new JsonSerializer(),
            new FrontMatter()
        )
    );
    $application->add(
        new CorePurgeCommand(
            $mongoCredentials['db']
        )
    );
}
$application->run();
